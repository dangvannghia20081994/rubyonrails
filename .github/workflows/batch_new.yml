name: Staging Batch

on:
  push:
    branches:
      - 'feature/*'

permissions:
  contents: read
  id-token: write

jobs:
  matrix:
    name: Generate output
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.step1.outputs.matrix }}
    steps:
      - name: Checkout to repository
        uses: actions/checkout@v4

      - id: step1
        name: Convert config from YAML to JSON and pass it as value to matrix
        run: |
          envsubst < ./.github/workflows/config.yml
          matrix="matrix=$(yq -P -o=json ./.github/workflows/config.yml | jq -c .)"
          echo $matrix
          echo $matrix >> $GITHUB_OUTPUT
        env:
          PREFIX: s-cnb-
          PREPEND: "@prj-docomo-mamatena-s-d568c051.iam.gs"

  deploy-staging:
    needs: [matrix]
    strategy:
      matrix: ${{ fromJSON(needs.matrix.outputs.matrix) }}
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check task with matrix
        run: |
          echo ${{ matrix.batch-name}}
          echo ${{ matrix.service-account-name}}
